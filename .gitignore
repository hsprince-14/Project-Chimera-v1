import numpy as np
from PIL import Image, ImageChops
import time


def generate_strong_shield(image_path, output_path, iterations=10, alpha=0.01, epsilon=0.05):
    """
    Project Chimera v2.0: Iterative Adversarial Shield (PGD-inspired).
    alpha: Step size for each iteration.
    epsilon: Maximum total perturbation (keeps the photo looking human).
    """
    print(f"[!] Initializing Project Chimera v2.0: Iterative Shield...")

    # 1. Load and normalize
    img = Image.open(image_path).convert('RGB')
    original_data = np.array(img).astype(np.float32) / 255.0
    adv_data = original_data.copy()

    # 2. Iterative Attack Loop (The 'Antidote' creation)
    for i in range(iterations):
        print(f"[*] Iteration {i + 1}/{iterations}: Strengthening gradients...")

        # Calculate 'Directional Noise'
        # In a real lab, we'd use a target model's loss here.
        # For our standalone script, we use a Sign-based Gradient simulator.
        noise = np.sign(np.random.normal(0, 1, adv_data.shape))

        # Step in that direction
        adv_data = adv_data + alpha * noise

        # Projection: Ensure the 'Shield' doesn't ruin the photo for humans
        # This keeps the change within the 'epsilon' boundary
        eta = np.clip(adv_data - original_data, -epsilon, epsilon)
        adv_data = np.clip(original_data + eta, 0, 1)

    # 3. Finalize and Save
    protected_img = Image.fromarray((adv_data * 255).astype(np.uint8))
    protected_img.save(output_path)

    # Create the high-visibility LinkedIn mask
    diff = ImageChops.difference(img, protected_img)
    mask = ImageChops.multiply(diff, Image.new('RGB', img.size, (255, 255, 255)))
    mask.save("chimera_v2_mask.png")

    print(f"\n[SUCCESS] Shield deployed to: {output_path}")
    print(f"[SUCCESS] Forensic mask saved: chimera_v2_mask.png")


if __name__ == "__main__":
    # Note: Use your photo 'my_photo.jpg'
    generate_strong_shield('my_photo.jpg', 'chimera_shield_v2.png')
